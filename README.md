# CG-Mode
CG Mode Extension for SillyTavern

CG-Mode 是一个旨在增强 SillyTavern 沉浸感的扩展插件。它允许通过世界书（World Info）触发特定标签，自动切换背景图片、显示/隐藏角色立绘，并播放背景音乐（BGM）与环境音效（Ambient）。

## 功能特性

### 🖼️ 自动背景切换

- 支持CG（立绘隐藏）和BG（立绘显示）两种模式
- 通过世界书中的 [CG:图片名] 和 [BG:图片名] 标签自动切换
- 支持为移动端单独设置竖屏图片路径，自动适配设备
- 本地/远程资源支持：支持连接本地静态资源服务器（推荐）或直接调用酒馆内置背景
- 支持图片格式：PNG、JPG、JPEG、GIF、WEBP、BMP

### 🎵 音频管理

- 自动播放背景音乐（BGM）通过 [BGM:音乐名] 标签
- 自动播放环境音效（AMB）通过 [AMB:音效名] 标签
- 音频淡出效果，平滑过渡
- 与酒馆助手的音频系统集成

### ⌨️ 斜杠命令

- /setcg 图片名 - 手动设置CG图片
- /setbg 图片名 - 手动设置BG图片

安装方法

1. 在酒馆安装扩展
```
https://github.com/JiXun-dfwe/CG-Mode
```
2. 重启SillyTavern或重新加载页面

## 配置说明

### 基本设置

- 启用扩展：开启或关闭CG模式功能
- 本地模式：使用酒馆内置或上传的背景图片（标签内的文件名需要完全匹配酒馆内的背景名）
- 扫描消息数量：设置扫描最近多少条消息中的世界书标签（默认2条）
- 资源服务器地址：存放图片和音频文件的服务器URL

**为了获得最佳体验（避免图片混杂在酒馆主目录），建议搭建一个简单的本地静态资源服务器（HTTP Server）来存放图片资源**
如何启动简单服务器： 如果你安装了 Python，可以在 MyAssets 文件夹下运行终端命令：
|
###### 启动一个端口为 8000 的服务器
```
python -m http.server 8000 --bind 127.0.0.1
```

*(注意：为了确保扩展能检测到文件，请确保你的服务器支持 CORS 跨域请求，或者你的酒馆与资源服务器处于同一域下)*


### 文件夹配置

- 桌面端CG文件夹：桌面设备专用的CG图片文件夹
- 桌面端BG文件夹：桌面设备专用的BG图片文件夹
- 移动端CG文件夹：移动设备专用的CG图片文件夹
- 移动端BG文件夹：移动设备专用的BG图片文件夹

### 文件命名规则

- 图片文件只需提供名称，扩展名会自动匹配
- 示例：世界书中使用 [CG:scene1]，实际文件可以是 scene1.png、scene1.jpg 等

## 使用方法

### 自动模式

在世界书中使用以下标签：

```
[CG:场景图片名]      # 切换为CG模式，隐藏立绘 
[BG:背景图片名]      # 切换为BG模式，显示立绘  
[BGM:背景音乐名]     # 播放指定背景音乐
[AMB:环境音效名]     # 播放指定环境音效
```
_示例：[CG:battle_scene_01] 会查找 images/cg/battle_scene_01.png_

### 手动模式

在聊天窗口中使用斜杠命令：

```
/setcg 场景图片名     # 手动切换到CG图片
/setbg 背景图片名     # 手动切换到BG图片
```

### 文件结构要求

```
资源服务器/
├── cg/              # CG图片文件夹
│   ├── scene1.png
│   └── scene2.jpg
├── bg/              # BG图片文件夹
│   ├── location1.png
│   └── location2.jpg
├── bg_mobile/      # 存放手机竖屏背景 (可选)
│── cg_mobile/      # 存放手机竖屏CG (可选)
└── 根目录图片文件      # 也可直接放在根目录
```

### 注意事项

1. 服务器配置：确保资源服务器允许跨域访问（CORS）
2. 文件存在性：扩展会自动检查文件是否存在，找不到文件时会显示警告
3. 音频集成：BGM和AMB需要先在酒馆助手的播放器中导入，标签将会匹配Title (标题)，请确保音频已上传且标题无误
4. 优先级：如果同时扫描到多个标签，通常会执行最后扫描到的那个（受限于世界书的触发顺序）
5. 性能优化：图片会预加载，避免切换时的延迟

### 故障排除

- 连接测试：使用设置中的"测试连接"按钮检查服务器可达性
- 控制台日志：查看浏览器控制台获取详细调试信息
- 文件路径：确认文件夹配置正确，文件名不含扩展名

### 更新日志

v1.0

- 初始版本发布
- 支持自动背景切换和音频播放
- 添加斜杠命令支持

---

如有问题或建议，请访问项目仓库提交Issue。
